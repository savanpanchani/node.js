<%- include('../header') %>

    <div class="page-wrapper">
        <div class="page-breadcrumb">
            <div class="row">
                <div class="col-12 d-flex no-block align-items-center">
                    <h4 class="page-title">Edit Product</h4>
                </div>
            </div>
        </div>

        <div class="container-fluid">
            <div class="row">
                <div class="col-md-8">

                    <div class="card">
                        <form class="form-horizontal" action="/product/edit-product/<%= product._id %>" method="post"
                            enctype="multipart/form-data">

                            <div class="card-body">
                                <h4 class="card-title">Edit Product Details</h4>

                                <div class="form-group row">
                                    <label class="col-sm-3 text-right control-label col-form-label">Title</label>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control" name="title"
                                            value="<%= product.title %>" required>
                                    </div>
                                </div>

                                <div class="form-group row">
                                    <label class="col-sm-3 text-right control-label col-form-label">Description</label>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control" name="desc" value="<%= product.desc %>"
                                            required>
                                    </div>
                                </div>

                                <div class="form-group row">
                                    <label class="col-sm-3 text-right control-label col-form-label">Category</label>
                                    <div class="col-sm-9">
                                        <select name="category" id="categorySelect" class="form-control" required>
                                            <option value=""> Select Category </option>

                                            <% categories.forEach(c=> { %>
                                                <option value="<%= c._id %>" <%=product.category &&
                                                    product.category._id.toString()===c._id.toString() ? 'selected' : ''
                                                    %>>
                                                    <%= c.categoryName %>
                                                </option>
                                                <% }) %>

                                        </select>
                                    </div>
                                </div>

                                <div class="form-group row">
                                    <label class="col-sm-3 text-right control-label col-form-label">Sub Category</label>
                                    <div class="col-sm-9">
                                        <select name="subcategory" id="subCategorySelect" class="form-control" required>
                                            <option value="">Select SubCategory</option>

                                            <% subCategories.forEach(s=> { %>
                                                <option value="<%= s._id %>" <%=product.subcategory &&
                                                    product.subcategory._id.toString()===s._id.toString() ? 'selected'
                                                    : '' %>>
                                                    <%= s.subCategoryName %>
                                                </option>
                                                <% }) %>

                                        </select>
                                    </div>
                                </div>

                                <div class="form-group row">
                                    <label class="col-sm-3 text-right control-label col-form-label">Extra
                                        Category</label>
                                    <div class="col-sm-9">
                                        <select name="extracategory" id="extraCategorySelect" class="form-control">
                                            <option value=""> Select Extra Category </option>

                                            <% extraCategories.forEach(e=> { %>
                                                <option value="<%= e._id %>" <%=product.extracategory &&
                                                    product.extracategory.toString()===e._id.toString() ? 'selected'
                                                    : '' %>>
                                                    <%= e.extraCategory %>
                                                </option>
                                                <% }) %>


                                        </select>
                                    </div>
                                </div>

                                <div class="form-group row">
                                    <label class="col-sm-3 text-right control-label col-form-label">Price</label>
                                    <div class="col-sm-9">
                                        <input type="number" class="form-control" name="price"
                                            value="<%= product.price %>" required>
                                    </div>
                                </div>

                                <div class="form-group row">
                                    <label class="col-sm-3 text-right control-label col-form-label">Quantity</label>
                                    <div class="col-sm-9">
                                        <input type="number" class="form-control" name="quantity"
                                            value="<%= product.quantity %>" required>
                                    </div>
                                </div>

                                <div class="form-group row">
                                    <label class="col-sm-3 text-right control-label col-form-label">Product
                                        Image</label>
                                    <div class="col-md-9">

                                        <img src="<%= product.productImage.startsWith('/') ? product.productImage : '/' + product.productImage %>"
                                            style="height: 100px; width: 100px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;">


                                        <div class="custom-file">
                                            <input type="file" class="custom-file-input" name="productImage">
                                            <label class="custom-file-label">Choose new file...</label>
                                        </div>

                                    </div>
                                </div>

                            </div>

                            <div class="border-top">
                                <div class="card-body">
                                    <button type="submit" class="btn btn-primary">Update Product</button>
                                    <a href="/product/view-product" class="btn btn-secondary">Cancel</a>
                                </div>
                            </div>

                        </form>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <%- include('../footer') %>


        <script>
            (function () {
                const categorySelect = document.getElementById("categorySelect");
                const subCategorySelect = document.getElementById("subCategorySelect");
                const extraCategorySelect = document.getElementById("extraCategorySelect");

                categorySelect && categorySelect.addEventListener("change", async function () {
                    const catId = this.value;
                    subCategorySelect.innerHTML = '<option value="">-- Select SubCategory --</option>';
                    extraCategorySelect.innerHTML = '<option value="">-- Select Extra Category --</option>';

                    if (!catId) return;

                    const res = await fetch('/product/get-subcategories/' + catId);
                    const data = await res.json();
                    data.forEach(sc => {
                        const op = document.createElement('option');
                        op.value = sc._id;
                        op.textContent = sc.subCategoryName;
                        subCategorySelect.appendChild(op);
                    });
                });

                subCategorySelect && subCategorySelect.addEventListener("change", async function () {
                    const subId = this.value;
                    extraCategorySelect.innerHTML = '<option value="">-- Select Extra Category --</option>';

                    if (!subId) return;

                    const res = await fetch('/product/get-extra/' + subId);
                    const data = await res.json();
                    data.forEach(ec => {
                        const op = document.createElement('option');
                        op.value = ec._id;
                        op.textContent = ec.extraCategory;
                        extraCategorySelect.appendChild(op);
                    });
                });
            })();
        </script>